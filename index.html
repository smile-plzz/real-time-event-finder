<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Event Finder</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Leaflet.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Leaflet.markercluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />
    <style>
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: #1f2937; /* bg-gray-800 */
            color: #f9fafb; /* text-gray-50 */
        }
        .leaflet-popup-content a {
            color: #60a5fa; /* text-blue-400 */
        }
        .leaflet-container {
            background: #111827; /* bg-gray-900 */
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans antialiased">
    <div id="root"></div>

    <!-- React CDN -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>
    <!-- Leaflet.js JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Leaflet.markercluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Custom hook for debouncing
        const useDebounce = (value, delay) => {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedValue(value);
                }, delay);
                return () => {
                    clearTimeout(handler);
                };
            }, [value, delay]);
            return debouncedValue;
        };

        const App = () => {
            const [events, setEvents] = useState([]);
            const [savedEvents, setSavedEvents] = useState(() => {
                try {
                    const localData = localStorage.getItem('savedEvents');
                    return localData ? JSON.parse(localData) : [];
                } catch (error) {
                    console.error("Error parsing saved events from localStorage:", error);
                    return [];
                }
            });
            const [filters, setFilters] = useState({ location: '', category: '', keyword: '' });
            const [view, setView] = useState('list'); // 'list' or 'map'
            const [notificationPermission, setNotificationPermission] = useState(Notification.permission);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            const debouncedFilters = useDebounce(filters, 500);
            const TICKETMASTER_API_KEY = 'PG5acZnvvPy3Yq1AtAk1HJmIapqtJIWs';

            useEffect(() => {
                localStorage.setItem('savedEvents', JSON.stringify(savedEvents));
            }, [savedEvents]);

            const fetchEvents = useCallback(async (currentFilters) => {
                setIsLoading(true);
                setError(null);
                let url = `https://app.ticketmaster.com/discovery/v2/events.json?apikey=${TICKETMASTER_API_KEY}&size=200`;
                if (currentFilters.location) url += `&city=${currentFilters.location}`;
                if (currentFilters.category) url += `&classificationName=${currentFilters.category}`;
                if (currentFilters.keyword) url += `&keyword=${currentFilters.keyword}`;

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const data = await response.json();
                    setEvents(data._embedded?.events || []);
                } catch (err) {
                    console.error("Error fetching events:", err);
                    setError('Could not fetch events. Please try a different search.');
                } finally {
                    setIsLoading(false);
                }
            }, []);

            useEffect(() => {
                fetchEvents(debouncedFilters);
            }, [debouncedFilters, fetchEvents]);

            useEffect(() => {
                requestNotificationPermission();
            }, []);

            const requestNotificationPermission = () => {
                if ("Notification" in window && Notification.permission !== "granted") {
                    Notification.requestPermission().then(setNotificationPermission);
                }
            };

            const handleFilterChange = (e) => {
                const { name, value } = e.target;
                setFilters(prev => ({ ...prev, [name]: value }));
            };

            const handleGeolocation = () => {
                if (navigator.geolocation) {
                    setIsLoading(true);
                    setError(null);
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const { latitude, longitude } = position.coords;
                            let url = `https://app.ticketmaster.com/discovery/v2/events.json?apikey=${TICKETMASTER_API_KEY}&latlong=${latitude},${longitude}&size=200`;
                            try {
                                const response = await fetch(url);
                                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                                const data = await response.json();
                                setEvents(data._embedded?.events || []);
                                // Optionally, reverse geocode to set the city name in the input
                            } catch (err) {
                                console.error("Error fetching events by geolocation:", err);
                                setError('Could not fetch events for your location.');
                            } finally {
                                setIsLoading(false);
                            }
                        },
                        (err) => {
                            console.error("Geolocation error:", err);
                            alert("Unable to retrieve your location.");
                            setIsLoading(false);
                        }
                    );
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            };
            
            const clearFilters = () => {
                setFilters({ location: '', category: '', keyword: '' });
            };

            const saveEvent = (event) => {
                setSavedEvents(prev => prev.some(e => e.id === event.id) ? prev : [...prev, { ...event, notes: '' }]);
            };

            const removeSavedEvent = (eventId) => {
                setSavedEvents(prev => prev.filter(event => event.id !== eventId));
            };

            const updateSavedEventNotes = (eventId, notes) => {
                setSavedEvents(prev => prev.map(event => event.id === eventId ? { ...event, notes } : event));
            };

            const scheduleNotification = (event, time) => {
                if (notificationPermission === "granted") {
                    const eventDate = new Date(event.dates.start.dateTime);
                    const reminderTime = new Date(eventDate.getTime() - time * 60 * 1000);
                    if (reminderTime > new Date()) {
                        setTimeout(() => {
                            new Notification(event.name, { body: `Reminder: Your event is starting soon!`, icon: event.images?.[0]?.url });
                        }, reminderTime.getTime() - new Date().getTime());
                        alert(`Reminder set for ${event.name}`);
                    } else {
                        alert("Cannot schedule reminder for a past event.");
                    }
                } else {
                    alert("Please grant notification permissions.");
                }
            };

            const LoadingSpinner = () => (
                <div className="flex justify-center items-center p-10"><div className="w-16 h-16 border-4 border-purple-400 border-t-transparent rounded-full animate-spin"></div></div>
            );

            const ErrorDisplay = ({ message }) => (
                <div className="text-center p-10 bg-red-900/20 border border-red-500 rounded-lg"><p className="text-red-400 font-semibold">Oops!</p><p className="text-red-300">{message}</p></div>
            );

            const EventCard = ({ event, onSave, onRemove, onUpdateNotes, isSaved, onScheduleNotification }) => {
                const [showNotes, setShowNotes] = useState(false);
                const [notes, setNotes] = useState(event.notes || '');
                const [reminderMinutes, setReminderMinutes] = useState(30);
                const imageUrl = event.images?.[0]?.url || 'https://via.placeholder.com/400x200/1f2937/FFFFFF?text=No+Image';
                return (
                    <div className="bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-6 transform transition duration-300 hover:scale-105 hover:shadow-purple-500/20 fade-in">
                        <img src={imageUrl} alt={event.name} className="w-full h-56 object-cover" loading="lazy"/>
                        <div className="p-5">
                            <h3 className="font-bold text-2xl mb-2 text-gray-100 leading-tight">{event.name}</h3>
                            <p className="text-gray-400 text-sm mb-1"><i className="fas fa-calendar-alt mr-2"></i>{event.dates.start.localDate} at {event.dates.start.localTime}</p>
                            <p className="text-gray-400 text-sm mb-2"><i className="fas fa-map-marker-alt mr-2"></i>{event._embedded?.venues?.[0]?.name} - {event._embedded?.venues?.[0]?.city?.name}</p>
                            <a href={event.url} target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline text-base font-medium"><i className="fas fa-ticket-alt mr-2"></i>Get Tickets</a>
                            <div className="mt-4 flex flex-wrap gap-2">
                                {isSaved ? (
                                    <><button onClick={() => onRemove(event.id)} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm"><i className="fas fa-trash-alt mr-2"></i>Remove</button><button onClick={() => setShowNotes(!showNotes)} className="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg text-sm"><i className="fas fa-sticky-note mr-2"></i>{showNotes ? 'Hide' : 'Notes'}</button></>
                                ) : (
                                    <button onClick={() => onSave(event)} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg text-sm"><i className="fas fa-bookmark mr-2"></i>Save</button>
                                )}
                            </div>
                            {isSaved && showNotes && (
                                <div className="mt-5 p-4 bg-gray-700 rounded-lg border border-gray-600 fade-in">
                                    <textarea className="w-full p-3 border-gray-600 bg-gray-800 rounded-md focus:ring-purple-500 text-sm mb-3 text-white" placeholder="Add notes..." value={notes} onChange={(e) => { setNotes(e.target.value); onUpdateNotes(event.id, e.target.value); }}></textarea>
                                    <div className="flex items-center space-x-3">
                                        <select value={reminderMinutes} onChange={(e) => setReminderMinutes(parseInt(e.target.value))} className="p-2 border-gray-600 bg-gray-800 rounded-md text-sm focus:ring-purple-500 text-white"><option value="30">30 mins before</option><option value="60">1 hour before</option></select>
                                        <button onClick={() => onScheduleNotification(event, reminderMinutes)} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm"><i className="fas fa-bell mr-2"></i>Set Reminder</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const EventList = ({ events, ...props }) => (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    {events.length > 0 ? events.map(event => <EventCard key={event.id} event={event} {...props} />) : <p className="col-span-full text-center text-gray-400 text-lg py-10">No events found.</p>}
                </div>
            );

            const FilterBar = ({ filters, onChange, onGeolocation, onClear, onSearch }) => {
                const categories = ["Music", "Sports", "Arts & Theatre", "Family", "Film"];
                return (
                    <div className="bg-gray-800 p-6 rounded-lg shadow-inner mb-6 border border-gray-700">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <input type="text" name="location" value={filters.location} onChange={onChange} placeholder="Location (City)" className="w-full p-3 bg-gray-700 border-gray-600 rounded-md focus:ring-purple-500 text-white"/>
                            <select name="category" value={filters.category} onChange={onChange} className="w-full p-3 bg-gray-700 border-gray-600 rounded-md focus:ring-purple-500 text-white">
                                <option value="">All Categories</option>
                                {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                            </select>
                            <input type="text" name="keyword" value={filters.keyword} onChange={onChange} placeholder="Keyword (e.g., concert)" className="w-full p-3 bg-gray-700 border-gray-600 rounded-md focus:ring-purple-500 text-white"/>
                            <button onClick={onGeolocation} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md"><i className="fas fa-location-arrow mr-2"></i>Use My Location</button>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => onSearch(filters)} className="w-full bg-purple-700 hover:bg-purple-800 text-white font-bold py-3 rounded-md shadow-lg transform hover:scale-105">Search</button>
                            <button onClick={onClear} className="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-md shadow-lg">Clear</button>
                        </div>
                    </div>
                );
            };

            const SavedEvents = ({ savedEvents, ...props }) => (
                <div className="mt-12 p-6 bg-gray-800 rounded-xl shadow-inner border-gray-700">
                    <h2 className="text-3xl font-bold text-gray-100 mb-6 text-center">My Saved Events</h2>
                    {savedEvents.length > 0 ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            {savedEvents.map(event => <EventCard key={event.id} event={event} isSaved={true} {...props} />)}
                        </div>
                    ) : (
                        <p className="text-gray-400 text-center text-lg py-10">You haven't saved any events yet.</p>
                    )}
                </div>
            );

            const MapView = ({ events }) => {
                const mapRef = useRef(null);
                const mapInstance = useRef(null);
                const markers = useRef(null);

                useEffect(() => {
                    if (typeof L === 'undefined') return;
                    if (!mapInstance.current && mapRef.current) {
                        mapInstance.current = L.map(mapRef.current).setView([40.7128, -74.0060], 10);
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO', subdomains: 'abcd', maxZoom: 19 }).addTo(mapInstance.current);
                        markers.current = L.markerClusterGroup();
                        mapInstance.current.addLayer(markers.current);
                    }

                    markers.current.clearLayers();
                    const eventMarkers = [];
                    events.forEach(event => {
                        const venue = event._embedded?.venues?.[0];
                        if (venue?.location) {
                            const marker = L.marker([venue.location.latitude, venue.location.longitude]);
                            marker.bindPopup(`<b>${event.name}</b><br>${venue.name}<br><a href="${event.url}" target="_blank">Get Tickets</a>`);
                            eventMarkers.push(marker);
                        }
                    });

                    if (eventMarkers.length > 0) {
                        markers.current.addLayers(eventMarkers);
                        const bounds = L.featureGroup(eventMarkers).getBounds();
                        if (bounds.isValid()) mapInstance.current.fitBounds(bounds.pad(0.1));
                    }
                }, [events]);

                return <div ref={mapRef} className="w-full h-[600px] bg-gray-800 rounded-lg shadow-lg mt-8"></div>;
            };

            return (
                <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                    <h1 className="text-5xl font-extrabold text-center text-purple-400 mb-8 tracking-tight">Real-Time Event Finder</h1>
                    <FilterBar filters={filters} onChange={handleFilterChange} onGeolocation={handleGeolocation} onClear={clearFilters} onSearch={fetchEvents} />
                    <div className="flex justify-center mb-8 bg-gray-800 rounded-full p-1 shadow-inner border-gray-700">
                        <button onClick={() => setView('list')} className={`py-2 px-6 rounded-full text-lg font-semibold transition-all duration-300 ${view === 'list' ? 'bg-purple-600 text-white shadow-md' : 'text-gray-300 hover:bg-gray-700'}`}>List</button>
                        <button onClick={() => setView('map')} className={`py-2 px-6 rounded-full text-lg font-semibold transition-all duration-300 ${view === 'map' ? 'bg-purple-600 text-white shadow-md' : 'text-gray-300 hover:bg-gray-700'}`}>Map</button>
                    </div>
                    {isLoading ? <LoadingSpinner /> : error ? <ErrorDisplay message={error} /> : (
                        view === 'list' ? <EventList events={events} savedEvents={savedEvents} onSave={saveEvent} onRemove={removeSavedEvent} onUpdateNotes={updateSavedEventNotes} onScheduleNotification={scheduleNotification} /> : <MapView events={events} />
                    )}
                    <SavedEvents savedEvents={savedEvents} onRemove={removeSavedEvent} onUpdateNotes={updateSavedEventNotes} onScheduleNotification={scheduleNotification} />
                </div>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>